---
title: "Turnout Tracker Walkthrough"
author: "Jonathan Tannen"
date: "March 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  dpi=300,
  root.dir = "C:/Users/Jonathan Tannen/Dropbox/sixty_six/posts/election_day_tracker/tracker_v0/"
)

setwd("C:/Users/Jonathan Tannen/Dropbox/sixty_six/posts/election_day_tracker/tracker_v0/")
```


## Introduction
This document is a walkthrough of how to use the code for the Turnout Tracker. For a discussion of the math and the model, see [Turnout Tracker Math](../methodology.html)

## Before Election Day: Fitting the Model

There are a number of parameters that need to be fit on historical data: baseline turnout rates, precinct covariances, etc. 

Each election should have a config, which I've created in config.R. `config` is a list with the following items:
```{r config}
library(tidyverse)

setwd("phila_example")
source("config.R")
print(config)
```

All of the prep work is done in `calc_params`. The input is a dataframe, `turnout_df`, which has columns `precinct, year, turnout`. Precinct is the unique identifier for the precinct, year is the year, and turnout is the voter count. Internally, we'll validate that there is a turnout value for every `precinct` in every `year`, so you will need to crosswalk turnout if boundaries have changed.

```{r turnout_df}
df <- read.csv(config$turnout_df_path)
df$precinct <- sprintf("%04d", df$precinct)
head(arrange(df, precinct, year))
```

We can now calculate the historic `modelParams`:
```{r calc_params}
source("../calc_params.R", chdir=TRUE)

params <- calc_params(
  turnout_df=df, 
  n_svd=3
) 

## params has a copy of turnout_df, with some new columns.
print(head(params@turnout_df))

## params has an estimate of the year_fe, on the log scale.
print(head(params@year_fe))

## params has an estimate of the precinct_fe, on the log scale.
print(head(params@precinct_fe))

## params has the svd results, which is used for the covariance (more on this later).
print(head(params@svd$u))
print(head(params@svd$v))

## params has the estimated covariance matrix among precincts (and its inverse)
print(params@precinct_cov[1:6, 1:6])
```

I also provide some helper functions to make diagnostic plots. These require an `sf` object with the precinct shapefiles. The `sf` must have a column `precinct` which matches the id column in `turnout_df`.

The diagnostics include plots of (a) the fixed effects by precinct and by year, and (b) the svd components for the estimated covariances, along with each dimension's score in each year. You should sanity check that the combination of precincts and elections make sense.
```{r diagnostics}
library(sf)
divs <- st_read(config$precinct_shp_path, quiet = TRUE, )
divs$precinct <- divs[[config$precinct_id_col]]
head(divs)

diagnostics(params, divs)
```

The plots look good. Dimension 1 is blue for Hispanic North Philly and the University of Pennsylvania, and the line plot shows that these precincts had disproportionately high turnout in 2004, 2008, 2012, 2016 (the presidential elections). Dimension 2 has captured population change (red divisions are increasing, blue divisions are decreasing). Dimension 3 is hard to interpret, and may be noise/misfitting...

Let's save the results and move on.
```{r save_params}
save_with_backup(params, stem="params", dir="outputs")
```

