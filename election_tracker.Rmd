---
output: html_document
---

<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  min-width: 50%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

<!-- [![](`r if(dir.exists(add_election_path("images"))) add_election_path("/") else ""`images/icon.png){width=15%} -->
<!-- ![](`r if(dir.exists(add_election_path("images"))) add_election_path("/") else ""`images/logo.png){width=50%}](https://sixtysixwards.com) -->

```{r setup, include=FALSE, out.width='80%'}
library(dplyr)
library(stargazer)

source(add_election_path("config.R"))
source("util.R")
source("generate_plots.R")
source("bootstrap.R")

config <- extend_config(config)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)

params <- readRDS(output_file("params.Rds"))
bs <- readRDS(output_file("bootstrap.Rds"))

get_ward <- config$get_ward_from_precinct

raw_data <- readRDS(output_file("raw_data.Rds")) %>% 
  mutate(
    ward=get_ward(precinct),
    time_of_day=config$base_time + minutes(minute)
  )

current_time <- max(bs@raw_result@time_df$time_of_day)

turnout_df <- get_ci_from_bs(bs, predict_topline, keys="time_of_day")
current_turnout <- filter_to_eod(turnout_df)

ward_turnout <- get_ci_from_bs(
  bs, 
  predict_ward_turnout, 
  get_ward=get_ward,
  keys="ward"
)

precinct_turnout <- get_ci_from_bs(
  bs, 
  predict_precinct_eod,
  keys="precinct"
)

write.csv(
  precinct_turnout, 
  file=output_file(sprintf("precinct_turnout_%s.csv", config$city_filename)), 
  row.names=FALSE
)

wards <- readRDS(add_election_path("data/wards.Rds"))
wards <- wards %>% left_join(ward_turnout)

## for text reference
attach(config)

if("mail_in_text" %in% names(config)){
  mail_in_text <- config$mail_in_text
}else{
  mail_in_text <- ""
}

save_plot <- function(p, stem){
  file <- sprintf(
    output_file("%s_%s.png"),
    stem,
    format(Sys.time(), "%H_%M_%S")
  )
  ggsave(p, file=file)
}
```
# Live `r substr(election_ds, 1, 4)` Election Turnout Tracker

Welcome to the [`r site_name`](`r site_link`) Turnout Tracker! 
Voters across `r city` are sharing their turnout to support citizen science. 

> First, vote! Then, share your `r precinct_name` and Voter Number at `r config$submission_bitly`.

## Live Results

```{r turnout, echo=FALSE, out.width='100%'}
tp <- turnout_plot(bs, raw_data, config)
save_plot(tp, "turnout")
tp
```

As of `r pretty_time(current_time)`, `r scales::comma(nrow(raw_data))` voters in `r length(unique(raw_data$ward))` wards have [shared their voter number](`r submission_bitly`). I estimate that <b>`r scales::comma(round(current_turnout$turnout))`</b> people have voted across the city (95% Confidence Interval: `r scales::comma(round(current_turnout$p025))` - `r scales::comma(round(current_turnout$p975))`). `r mail_in_text`

## Maps
I use historic correlations among `r precinct_name`s' turnout to estimate turnout in the `r precinct_name`s with no data yet. I simultaneously estimate (1) the overall city-wide turnout, (2) `r precinct_name`s' over-/under-performance, and (3) the city-wide time pattern of voting.

Here are the current estimates of turnout in each ward

### Turnout Predictions
```{r turnout_map, echo=FALSE, fig.width=6, fig.asp=1.0, fig.align="center"}
# turnout_map <- gg_wards_predicted(wards, current_time, config)
turnout_map <- leaflet_wards_predicted(wards, raw_data, config, current_time)
turnout_map
```

### Change in Turnout
```{r relative_map, echo=FALSE, fig.width=6, fig.asp=1.0, fig.align="center"}
# rel_map <- gg_wards_relative(wards, current_time, config)
# save_plot(relmap, "relative_map")
rel_map <- leaflet_wards_change(
  wards=wards, 
  raw_data=raw_data, 
  config=config, 
  current_time=current_time
)
rel_map
```

### Submissions
```{r ward_table, echo=FALSE, fig.width=6, fig.asp=1.0, fig.align="center"}
leaflet_submissions(
  wards=wards, 
  raw_data=raw_data, 
  config=config, 
  current_time=current_time
)
```

## Data Tables
For those of you who like tables with numbers.
```{r map_labelled, echo=FALSE, out.width='100%'}
gg_wards_labelled(wards)
```

```{r table, results='asis'}
stargazer(
  ward_turnout %>% 
    mutate(
      time_of_day=pretty_time(current_time)
    ) %>%
    select(ward, time_of_day, turnout, turnout_p025, turnout_p975) %>%
    mutate_at(
      vars(turnout, turnout_p025, turnout_p975),
      funs(round)
    ),
  type = "html",
  title = "Estimated Turnout by Ward",
  summary = FALSE,
  rownames = FALSE
)
```

## Raw Submissions

```{r raw_data, results='asis'}
stargazer(
  raw_data %>% 
    select(time_of_day, precinct, obs) %>%
    mutate(time_of_day = pretty_time(time_of_day)) %>%
    rename(
      `Time of Vote` = time_of_day, 
      `Precinct`=precinct, 
      `Voter Number` = obs
    ), 
  type = "html",
  title = "Submitted Data", 
  summary = FALSE,
  rownames = FALSE
)
```

**Download the csvs**: - [Raw Submissions](`r sprintf("https://jtannen.github.io/raw_data_%s.csv", config$city_filename)`) - [Division Predictions](`r sprintf("https://jtannen.github.io/precinct_turnout_%s.csv", config$city_filename)`)