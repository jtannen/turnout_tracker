---
output: html_document
---

<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  min-width: 50%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

![](`r if(dir.exists("images")) paste0(getwd(),"/") else ""`images/sixtysixwards_blue_on_red_icon.png){width=2px;height=2px}
![](`r if(dir.exists("images")) paste0(getwd(),"/") else ""`images/logo.png){width=2px;height=2px}

```{r setup, include=FALSE, out.width='80%'}
library(dplyr)
library(stargazer)

source("config.R")
source("../util.R", chdir=TRUE)
source("../generate_plots.R", chdir=TRUE)

config <- extend_config(config)

knitr::opts_chunk$set(echo = FALSE)

params <- safe_load("outputs/params.Rda")
bs <- safe_load("outputs/bootstrap.Rda")
turnout_ci <- tail(bs$bootstrap_ci, 1)

get_ward <- config$get_ward_from_precinct

raw_data <- load_data(TRUE, config, params)$raw_data
raw_data <- raw_data %>% mutate(ward = config$get_ward(precinct))

current_time <- max(bs$single_result$time_df$time_of_day)
ward_turnout <- bs$single_result$full_predictions %>%
  mutate(ward = get_ward(precinct)) %>%
  filter(time_of_day == current_time) %>%
  group_by(ward) %>%
  summarise(
    turnout = sum(prediction),
    sum_fe = sum(exp(precinct_fe)),
    re_over_fe = sum(exp(re_fit)) / sum(exp(precinct_fe))
  )

ward_ci <- bs$bootstrap_topline %>%
  select(log_fit, sim) %>%
  left_join(bs$ranef_df) %>%
  mutate(ward = get_ward(precinct)) %>%
  group_by(ward, sim) %>%
  summarise(turnout = sum(exp(log_fit + re_fit))) %>%
  group_by(ward) %>%
  summarise(
    turnout_low = quantile(turnout, 0.025),
    turnout_high = quantile(turnout, 0.975),
    turnout_median = quantile(turnout, 0.5)
  )

wards <- safe_load("data/wards.Rda")
wards <- wards %>% 
  left_join(ward_turnout) %>%
  left_join(ward_ci)

## for text reference
attach(config)
```
# `r site_name` Live `r substr(election_ds, 1, 4)` Election Turnout Tracker

Welcome to the [`r site_name`](http://www.sixtysixwards.com) turnout tracker! 
Voters across `r city` are sharing their turnout to support citizen science. 

> First, vote! Then, share your Division and Voter Number at `r config$submission_bitly`.

## Live Results

```{r turnout, echo=FALSE, out.width='100%'}
turnout_plot(
  bs,
  raw_data,
  config
)
```

As of `r strip_leading_zero(format(current_time, "%I:%M"))`, `r scales::comma(nrow(raw_data))` voters in `r length(unique(raw_data$ward))` wards have [shared their voter number](`r submission_bitly`). I estimate that <b>`r scales::comma(round(turnout_ci$turnout_500))`</b> people have voted across the city (95% Confidence Interval: `r scales::comma(round(turnout_ci$turnout_025))` - `r scales::comma(round(turnout_ci$turnout_975))`). 

## Maps
I use historic correlations among `r precinct_name`s' turnout to estimate turnout in the `r precinct_name`s with no data yet. I simultaneously estimate (1) the overall city-wide turnout, (2) `r precinct_name`s' over-/under-performance, and (3) the city-wide time pattern of voting.

Here are the current estimates of turnout in each ward
```{r maps, echo=FALSE, out.width='100%'}
gg_wards_predicted(wards, current_time)
gg_wards_relative(wards, current_time)
# gg_wards_turnout_change(wards, prior_turnout)
gg_wards_submissions(wards, raw_data, current_time)
```

## Data Tables
For those of you who like tables with numbers.
```{r map_labelled, echo=FALSE, out.width='100%'}
gg_wards_labelled(wards)
```

```{r table, results='asis'}
## TODO ward-level CIs
stargazer(
  ward_turnout %>% 
    left_join(ward_ci) %>%
    mutate(time_of_day=current_time) %>%
    select(ward, time_of_day, turnout, turnout_high, turnout_low) %>%
    mutate_at(
      vars(turnout, turnout_high, turnout_low),
      funs(round)
    ),
  type = "html",
  title = "Estimated Turnout by Ward",
  summary = FALSE,
  rownames = FALSE
)
```

## Raw Submissions

```{r raw_data, results='asis'}
stargazer(
  raw_data %>% 
    mutate(time = format(config$base_time + minutes(minute), "%I:%M")) %>%
    select(time, precinct, obs) %>%
    rename(`Time of Vote` = time, `Precinct`=precinct, `Voter Number` = obs), 
  type = "html",
  title = "Submitted Data", 
  summary = FALSE,
  rownames = FALSE
)
```

